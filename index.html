<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Produ√ß√£o de Necessaire - Otimiza√ß√£o Avan√ßada</title>
    <style>
        :root {
            --cor-primaria: #2c5530;
            --cor-secundaria: #4a7c59;
            --cor-destaque: #e8f5e8;
            --cor-fundo: #f5f5f5;
            --cor-texto-claro: white;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 10px;
            background-color: var(--cor-fundo);
        }
        
        .container {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        h1 {
            color: var(--cor-primaria);
            text-align: center;
            margin-bottom: 30px;
            font-size: 28px;
        }
        
        h2 {
            color: var(--cor-secundaria);
            border-bottom: 2px solid var(--cor-secundaria);
            padding-bottom: 10px;
            margin-top: 30px;
        }
        
        h3 {
            color: #5d8b6a;
            margin-top: 20px;
        }
        
        .input-group {
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid var(--cor-secundaria);
        }
        
        label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: var(--cor-primaria);
        }
        
        input[type="number"] {
            width: 100px;
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input[type="number"]:focus {
            outline: none;
            border-color: var(--cor-secundaria);
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .card {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .result-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .result-table th {
            background-color: var(--cor-secundaria);
            color: var(--cor-texto-claro);
            padding: 12px;
            text-align: left;
            font-weight: bold;
        }
        
        .result-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
        }
        
        .result-table tr:hover {
            background-color: #f8f9fa;
        }
        
        .highlight {
            background-color: var(--cor-destaque);
            font-weight: bold;
            color: var(--cor-primaria);
        }
        
        .calc-button {
            background-color: var(--cor-secundaria);
            color: var(--cor-texto-claro);
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
            margin: 10px 5px;
        }
        
        .calc-button:hover {
            background-color: var(--cor-primaria);
        }
        
        .print-button {
            background-color: #28a745;
            color: var(--cor-texto-claro);
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
            margin: 15px 5px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .print-button:hover {
            background-color: #218838;
        }
        
        .print-button:before {
            content: "üñ®Ô∏è";
        }

        /* --- ESTILOS DO MAPA DE CORTE VISUAL --- */
        .cutting-layout-container {
            border: 2px solid var(--cor-secundaria);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            background-color: #fafafa;
        }

        .cutting-layout {
            position: relative;
            background: #f0f0f0;
            border: 1px dashed #ccc;
            overflow: hidden;
            margin-top: 10px;
        }

        .cutting-piece {
            position: absolute;
            box-sizing: border-box;
            border: 1px solid rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: var(--cor-primaria);
            text-align: center;
            overflow: hidden;
            white-space: nowrap;
            cursor: help;
        }

        .cutting-piece .tooltip {
            visibility: hidden;
            width: 180px;
            background-color: var(--cor-primaria);
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 110%;
            left: 50%;
            margin-left: -90px;
            opacity: 0;
            transition: opacity 0.3s;
            white-space: normal;
        }

        .cutting-piece:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }
        
        /* ESTILOS PARA IMPRESS√ÉO */
        @media print {
            body {
                background: white !important;
                font-size: 12pt;
                margin: 0;
                padding: 10px;
            }
            
            .no-print {
                display: none !important;
            }
            
            .container {
                box-shadow: none !important;
                border: none !important;
                margin: 0 !important;
                padding: 0 !important;
                page-break-inside: avoid;
            }
            
            .result-table {
                box-shadow: none !important;
                border: 1px solid #333 !important;
            }
            
            .result-table th {
                background-color: #f0f0f0 !important;
                color: #333 !important;
                border: 1px solid #333 !important;
            }
            
            .result-table td {
                border: 1px solid #333 !important;
            }
            
            .highlight {
                background-color: #f5f5f5 !important;
                color: #000 !important;
            }
            
            h1, h2, h3 {
                color: #000 !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üßµ Calculadora de Produ√ß√£o de Necessaire</h1>
        
        <div class="input-group">
            <label for="quantity">Quantidade de Necessaires a Produzir:</label>
            <input type="number" id="quantity" min="1" value="1" onchange="calculateMaterials()">
            <button class="calc-button" onclick="calculateMaterials()">Calcular Materiais</button>
        </div>
    </div>

    <div id="print-area">
        <div class="container" id="summary-container">
            <h2>üìä Resumo de Materiais Necess√°rios</h2>
            <div id="summary"></div>
        </div>

        <div class="container" id="shopping-list-container">
            <h2>üõí Lista de Compras</h2>
            <div style="text-align: center; margin-bottom: 20px;" class="no-print">
                <button class="print-button" onclick="printShoppingList()">Imprimir Lista de Compras</button>
            </div>
            <div id="shopping-list"></div>
        </div>
    </div>

    <div class="container no-print">
        <h2>‚úÇÔ∏è Mapeamento de Corte Otimizado (com Rota√ß√£o)</h2>
        <div id="cutting-map"></div>
    </div>

    <script>
        // Dados base para 1 necessaire
        const baseData = {
            tecido: [
                {nome: 'Corpo atr√°s', largura: 15, comprimento: 26, quantidade: 1},
                {nome: 'Corpo frente (baixo)', largura: 13, comprimento: 26, quantidade: 1},
                {nome: 'Corpo frente (cima)', largura: 9, comprimento: 26, quantidade: 1},
                {nome: 'Fundo', largura: 14, comprimento: 42, quantidade: 1},
                {nome: 'Faixa de z√≠per', largura: 7, comprimento: 42, quantidade: 2},
                {nome: 'Faixa para vivo', largura: 3, comprimento: 82, quantidade: 2},
                {nome: 'Al√ßa de m√£o (opcional)', largura: 5, comprimento: 25, quantidade: 1},
                {nome: 'Freios z√≠per bolsos', largura: 3, comprimento: 4, quantidade: 8},
                {nome: 'Freios z√≠per fole (opcional)', largura: 5, comprimento: 4, quantidade: 1}
            ],
            forro: [
                {nome: 'Corpo atr√°s', largura: 15, comprimento: 26, quantidade: 3},
                {nome: 'Corpo frente (baixo)', largura: 13, comprimento: 26, quantidade: 1},
                {nome: 'Corpo frente (cima)', largura: 9, comprimento: 26, quantidade: 1},
                {nome: 'Faixa de z√≠per', largura: 7, comprimento: 42, quantidade: 2},
                {nome: 'Fundo', largura: 14, comprimento: 42, quantidade: 1}
            ],
            tela: [
                {nome: 'Bolso interno 1', largura: 12, comprimento: 26, quantidade: 1},
                {nome: 'Bolso interno 2', largura: 3, comprimento: 26, quantidade: 1},
                {nome: 'Bolso interno 3', largura: 12, comprimento: 26, quantidade: 1}
            ],
            eva: [
                {nome: 'Estrutura principal', largura: 11, comprimento: 22, quantidade: 1},
                {nome: 'Estrutura fundo', largura: 10, comprimento: 38, quantidade: 1},
                {nome: 'Estrutura lateral', largura: 3, comprimento: 38, quantidade: 2}
            ]
        };

        const outros = {
            fecho: 1.0,
            cursor: 4,
            vies: 2.05,
            cadaco_alca: 0.23,
            puxador: 4,
            cadaco_freio: 0.04
        };

        function calculateMaterials() {
            const quantity = parseInt(document.getElementById('quantity').value) || 1;
            
            const results = {
                tecido: calculateMaterialNeeds('tecido', quantity, 140),
                forro: calculateMaterialNeeds('forro', quantity, 140),
                tela: calculateMaterialNeeds('tela', quantity, 140),
                eva: calculateMaterialNeeds('eva', quantity, 130)
            };

            displaySummary(results, quantity);
            displayShoppingList(results, quantity);
            displayCuttingMap(results);
        }

        function calculateMaterialNeeds(type, quantity, materialWidth) {
            const items = baseData[type];
            let pieces = [];
            let totalArea = 0;

            items.forEach(item => {
                const totalPieces = item.quantidade * quantity;
                totalArea += item.largura * item.comprimento * totalPieces;
                for (let i = 0; i < totalPieces; i++) {
                    pieces.push({ ...item, id: `${item.nome}_${i}` });
                }
            });

            const layout = optimizeLayout(pieces, materialWidth);
            const totalLength = layout.totalHeight;
            const finalLength = Math.ceil(totalLength * 1.08);

            return {
                totalArea: totalArea,
                totalLength: totalLength,
                finalLength: finalLength,
                finalMeters: (finalLength / 100).toFixed(2),
                layout: layout,
                materialWidth: materialWidth
            };
        }

        function optimizeLayout(pieces, binWidth) {
            // Algoritmo de empacotamento 2D com rota√ß√£o (baseado em Bin Packing)
            pieces.sort((a, b) => Math.max(b.largura, b.comprimento) - Math.max(a.largura, a.comprimento));

            let bins = [{ width: binWidth, height: Infinity, nodes: [{ x: 0, y: 0, w: binWidth, h: Infinity }] }];
            let placedPieces = [];
            let totalHeight = 0;

            for (const piece of pieces) {
                let bestFit = null;

                for (let i = 0; i < bins[0].nodes.length; i++) {
                    const node = bins[0].nodes[i];
                    
                    // Tenta encaixar sem rota√ß√£o
                    if (piece.largura <= node.w && piece.comprimento <= node.h) {
                        const score = Math.min(node.w - piece.largura, node.h - piece.comprimento);
                        if (!bestFit || score < bestFit.score) {
                            bestFit = { nodeIndex: i, piece: { ...piece, rotacionada: false }, score: score };
                        }
                    }

                    // Tenta encaixar com rota√ß√£o
                    if (piece.comprimento <= node.w && piece.largura <= node.h) {
                         const score = Math.min(node.w - piece.comprimento, node.h - piece.largura);
                         if (!bestFit || score < bestFit.score) {
                            bestFit = { nodeIndex: i, piece: { ...piece, rotacionada: true }, score: score };
                        }
                    }
                }

                if (bestFit) {
                    const node = bins[0].nodes.splice(bestFit.nodeIndex, 1)[0];
                    const p = bestFit.piece;
                    const w = p.rotacionada ? p.comprimento : p.largura;
                    const h = p.rotacionada ? p.largura : p.comprimento;

                    placedPieces.push({ ...p, x: node.x, y: node.y, w: w, h: h });
                    totalHeight = Math.max(totalHeight, node.y + h);

                    // Adiciona novos n√≥s para os espa√ßos restantes
                    bins[0].nodes.push({ x: node.x + w, y: node.y, w: node.w - w, h: h });
                    bins[0].nodes.push({ x: node.x, y: node.y + h, w: node.w, h: node.h - h });

                    // Simplifica os n√≥s (remove n√≥s contidos em outros)
                    bins[0].nodes = bins[0].nodes.filter(n => n.w > 0 && n.h > 0);
                } else {
                     console.error("N√£o foi poss√≠vel encaixar a pe√ßa:", piece);
                }
            }
            
            const efficiency = binWidth * totalHeight > 0 ? (placedPieces.reduce((acc, p) => acc + (p.w * p.h), 0) / (binWidth * totalHeight) * 100).toFixed(1) : 0;

            return { placedPieces, totalHeight, efficiency };
        }

        function displaySummary(results, quantity) {
            const summaryDiv = document.getElementById('summary');
            const html = `
                <table class="result-table">
                    <thead>
                        <tr>
                            <th>Material</th>
                            <th>Metragem Otimizada</th>
                            <th>Comprar (com margem 8%)</th>
                            <th>Aproveitamento</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Tecido Principal</td>
                            <td>${(results.tecido.totalLength/100).toFixed(2)}m</td>
                            <td class="highlight">${results.tecido.finalMeters}m</td>
                            <td>${results.tecido.layout.efficiency}%</td>
                        </tr>
                        <tr>
                            <td>Forro</td>
                            <td>${(results.forro.totalLength/100).toFixed(2)}m</td>
                            <td class="highlight">${results.forro.finalMeters}m</td>
                            <td>${results.forro.layout.efficiency}%</td>
                        </tr>
                        <tr>
                            <td>Tela Voley</td>
                            <td>${(results.tela.totalLength/100).toFixed(2)}m</td>
                            <td class="highlight">${results.tela.finalMeters}m</td>
                            <td>${results.tela.layout.efficiency}%</td>
                        </tr>
                        <tr>
                            <td>EVA</td>
                            <td>${(results.eva.totalLength/100).toFixed(2)}m</td>
                            <td class="highlight">${results.eva.finalMeters}m</td>
                            <td>${results.eva.layout.efficiency}%</td>
                        </tr>
                    </tbody>
                </table>
                <h3>Outros Materiais (para ${quantity} necessaire${quantity > 1 ? 's' : ''})</h3>
                <table class="result-table">
                    <tbody>
                        <tr><td>Fecho n¬∫5</td><td class="highlight">${(outros.fecho * quantity).toFixed(2)}m</td></tr>
                        <tr><td>Cursores</td><td class="highlight">${outros.cursor * quantity} p√ßs</td></tr>
                        <tr><td>Vi√©s</td><td class="highlight">${(outros.vies * quantity).toFixed(2)}m</td></tr>
                        <tr><td>Cadar√ßo para al√ßa</td><td class="highlight">${(outros.cadaco_alca * quantity).toFixed(2)}m</td></tr>
                        <tr><td>Puxadores</td><td class="highlight">${outros.puxador * quantity} p√ßs</td></tr>
                        <tr><td>Cadar√ßo para freios</td><td class="highlight">${(outros.cadaco_freio * quantity).toFixed(2)}m</td></tr>
                    </tbody>
                </table>`;
            summaryDiv.innerHTML = html;
        }

        function displayShoppingList(results, quantity) {
            const shoppingDiv = document.getElementById('shopping-list');
            const html = `
                <div class="grid">
                    <div class="card">
                        <h3>üßµ Tecidos e Estrutura</h3>
                        <table class="result-table">
                            <thead><tr><th>Material</th><th>Quantidade</th></tr></thead>
                            <tbody>
                                <tr><td>Tecido Principal</td><td class="highlight">${results.tecido.finalMeters}m</td></tr>
                                <tr><td>Forro</td><td class="highlight">${results.forro.finalMeters}m</td></tr>
                                <tr><td>Tela Voley</td><td class="highlight">${results.tela.finalMeters}m</td></tr>
                                <tr><td>EVA (130cm largura)</td><td class="highlight">${results.eva.finalMeters}m</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="card">
                        <h3>‚ú® Aviamentos</h3>
                        <table class="result-table">
                            <thead><tr><th>Item</th><th>Quantidade</th></tr></thead>
                            <tbody>
                                <tr><td>Fecho n¬∫5</td><td class="highlight">${(outros.fecho * quantity).toFixed(2)}m</td></tr>
                                <tr><td>Cursores</td><td class="highlight">${outros.cursor * quantity} p√ßs</td></tr>
                                <tr><td>Vi√©s</td><td class="highlight">${(outros.vies * quantity).toFixed(2)}m</td></tr>
                                <tr><td>Cadar√ßo para al√ßa</td><td class="highlight">${(outros.cadaco_alca * quantity).toFixed(2)}m</td></tr>
                                <tr><td>Puxadores</td><td class="highlight">${outros.puxador * quantity} p√ßs</td></tr>
                                <tr><td>Cadar√ßo para freios</td><td class="highlight">${(outros.cadaco_freio * quantity).toFixed(2)}m</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>`;
            shoppingDiv.innerHTML = html;
        }

        function displayCuttingMap(results) {
            const cuttingMapDiv = document.getElementById('cutting-map');
            cuttingMapDiv.innerHTML = '';

            const materials = [
                { name: 'Tecido Principal', data: results.tecido },
                { name: 'Forro', data: results.forro },
                { name: 'Tela Voley', data: results.tela },
                { name: 'EVA', data: results.eva }
            ];

            const colors = ['#a8d8b4', '#f5d79e', '#a1c9f4', '#f4a1b9', '#c3a1f4', '#f4b9a1', '#f7c8a0', '#a0d9f7'];
            let colorIndex = 0;

            materials.forEach(material => {
                if (material.data.layout.totalHeight === 0) return;

                const container = document.createElement('div');
                container.className = 'cutting-layout-container';
                
                const title = document.createElement('h3');
                title.textContent = `${material.name} (Largura: ${material.data.materialWidth}cm)`;
                container.appendChild(title);

                const layoutDiv = document.createElement('div');
                layoutDiv.className = 'cutting-layout';

                const scale = Math.min(5, 800 / material.data.materialWidth); // Escala din√¢mica
                const totalLayoutHeight = material.data.layout.totalHeight;
                layoutDiv.style.width = `${material.data.materialWidth * scale}px`;
                layoutDiv.style.height = `${totalLayoutHeight * scale}px`;

                material.data.layout.placedPieces.forEach(piece => {
                    const pieceDiv = document.createElement('div');
                    pieceDiv.className = 'cutting-piece';
                    pieceDiv.style.width = `${piece.w * scale}px`;
                    pieceDiv.style.height = `${piece.h * scale}px`;
                    pieceDiv.style.left = `${piece.x * scale}px`;
                    pieceDiv.style.top = `${piece.y * scale}px`;
                    pieceDiv.style.backgroundColor = colors[colorIndex % colors.length];
                    
                    const tooltip = document.createElement('span');
                    tooltip.className = 'tooltip';
                    tooltip.textContent = `${piece.nome}: ${piece.largura}cm x ${piece.comprimento}cm ${piece.rotacionada ? '(rotacionado)' : ''}`;
                    pieceDiv.appendChild(tooltip);

                    layoutDiv.appendChild(pieceDiv);
                    colorIndex++;
                });

                container.appendChild(layoutDiv);
                cuttingMapDiv.appendChild(container);
            });
        }

        function printShoppingList() {
            window.print();
        }

        document.addEventListener('DOMContentLoaded', calculateMaterials);
    </script>
</body>
</html>
