<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Produ√ß√£o de Necessaire - Layout Inteligente</title>
    <style>
        :root {
            --cor-primaria: #2c5530;
            --cor-secundaria: #4a7c59;
            --cor-destaque: #e8f5e8;
            --cor-fundo: #f5f5f5;
            --cor-texto-claro: white;
            --cor-borda: #dee2e6;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 10px;
            background-color: var(--cor-fundo);
        }
        
        .container { background: white; border-radius: 10px; padding: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h1 { color: var(--cor-primaria); text-align: center; margin-bottom: 30px; font-size: 28px; }
        h2 { color: var(--cor-secundaria); border-bottom: 2px solid var(--cor-secundaria); padding-bottom: 10px; margin-top: 30px; }
        h3 { color: #5d8b6a; margin-top: 20px; }
        
        .input-group { margin: 20px 0; padding: 15px; background-color: #f8f9fa; border-radius: 8px; border-left: 4px solid var(--cor-secundaria); }
        label { display: block; font-weight: bold; margin-bottom: 8px; color: var(--cor-primaria); }
        input[type="number"] { width: 100px; padding: 8px 12px; border: 2px solid #ddd; border-radius: 5px; font-size: 16px; transition: border-color 0.3s; }
        input[type="number"]:focus { outline: none; border-color: var(--cor-secundaria); }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 20px 0; }
        .card { background: #fff; border: 1px solid var(--cor-borda); border-radius: 8px; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        
        .calc-button { background-color: var(--cor-secundaria); color: var(--cor-texto-claro); border: none; padding: 12px 25px; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; transition: background-color 0.3s; margin: 10px 5px; }
        .calc-button:hover { background-color: var(--cor-primaria); }
        
        .print-button { background-color: #28a745; color: var(--cor-texto-claro); border: none; padding: 12px 25px; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; transition: background-color 0.3s; margin: 15px 5px; display: inline-flex; align-items: center; gap: 8px; }
        .print-button:hover { background-color: #218838; }
        .print-button:before { content: "üñ®Ô∏è"; }

        /* --- RESUMO RESPONSIVO --- */
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        .summary-card { border: 1px solid var(--cor-borda); border-left: 4px solid var(--cor-secundaria); border-radius: 8px; padding: 15px; background-color: #fdfdfd; }
        .summary-card h4 { margin: 0 0 10px 0; color: var(--cor-primaria); }
        .summary-card p { margin: 4px 0; font-size: 14px; }
        .summary-card .highlight { font-size: 16px; font-weight: bold; color: var(--cor-secundaria); }

        /* --- MAPA DE CORTE AVAN√áADO --- */
        .cutting-section { border: 2px solid var(--cor-secundaria); border-radius: 8px; padding: 15px; margin-top: 15px; background-color: #fafafa; }
        .cutting-item-descriptive { background: var(--cor-destaque); padding: 8px 12px; margin: 5px 0; border-radius: 5px; border-left: 4px solid var(--cor-secundaria); font-size: 14px; }
        
        .cutting-layout-wrapper { display: grid; grid-template-columns: 1fr; gap: 20px; margin-top: 20px; align-items: flex-start; }
        @media (min-width: 992px) { .cutting-layout-wrapper { grid-template-columns: 3fr 1fr; } }

        .cutting-layout-viewport { position: relative; border: 1px solid #ccc; background-color: #fff; overflow: auto; max-height: 600px; }
        .cutting-layout-canvas-wrapper { position: relative; }
        .cutting-layout-canvas { position: relative; background: #f0f0f0; background-image: linear-gradient(rgba(0,0,0,0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(0,0,0,0.05) 1px, transparent 1px); }
        
        .ruler { position: absolute; background-color: rgba(255, 255, 255, 0.8); backdrop-filter: blur(2px); box-shadow: 0 0 5px rgba(0,0,0,0.1); z-index: 15; }
        .ruler.horizontal { top: -30px; left: 0; height: 30px; }
        .ruler.vertical { top: 0; left: -40px; width: 40px; }
        .ruler .tick { position: absolute; background: #333; }
        .ruler .tick.major { font-size: 10px; color: #333; }
        .ruler.horizontal .tick { bottom: 0; width: 1px; }
        .ruler.horizontal .tick.major { height: 15px; }
        .ruler.horizontal .tick.minor { height: 8px; }
        .ruler.vertical .tick { right: 0; height: 1px; }
        .ruler.vertical .tick.major { width: 15px; text-align: right; padding-right: 2px; }
        .ruler.vertical .tick.minor { width: 8px; }

        .guide-line { position: absolute; background-color: var(--cor-primaria); z-index: 20; }
        .guide-line.horizontal { width: 100%; height: 1px; }
        .guide-line.vertical { height: 100%; width: 1px; }

        .info-box { position: absolute; top: 5px; right: 5px; background: rgba(255,255,255,0.9); padding: 8px; border-radius: 5px; border: 1px solid var(--cor-borda); font-size: 12px; z-index: 30; pointer-events: none; }

        .cutting-piece { position: absolute; box-sizing: border-box; border: 1px solid rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; color: rgba(0,0,0,0.7); text-align: center; overflow: hidden; padding: 2px; transition: filter 0.2s ease, box-shadow 0.2s ease; }
        .cutting-piece.highlight { filter: brightness(1.2); box-shadow: 0 0 10px 3px yellow; z-index: 10; }

        .legend { list-style: none; padding: 0; margin: 0; border: 1px solid var(--cor-borda); border-radius: 8px; overflow: hidden; }
        .legend-item { display: flex; align-items: center; padding: 10px; font-size: 14px; border-bottom: 1px solid #eee; transition: background-color 0.2s ease; cursor: default; }
        .legend-item:last-child { border-bottom: none; }
        .legend-item.highlight { background-color: var(--cor-destaque); }
        .legend-color-box { width: 20px; height: 20px; margin-right: 10px; border: 1px solid rgba(0,0,0,0.2); flex-shrink: 0; }
        
        @media print {
            body { background: white !important; } .no-print { display: none !important; }
            .container { box-shadow: none !important; border: none !important; margin: 0 !important; padding: 0 !important; page-break-inside: avoid; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üßµ Calculadora de Produ√ß√£o de Necessaire</h1>
        <div class="input-group">
            <label for="quantity">Quantidade de Necessaires a Produzir:</label>
            <input type="number" id="quantity" min="1" value="1" onchange="calculateMaterials()">
            <button class="calc-button" onclick="calculateMaterials()">Calcular Materiais</button>
        </div>
    </div>

    <div id="print-area">
        <div class="container" id="summary-container">
            <h2>üìä Resumo de Materiais Necess√°rios</h2>
            <div id="summary-grid"></div>
        </div>
        <div class="container" id="shopping-list-container">
            <h2>üõí Lista de Compras</h2>
            <div style="text-align: center; margin-bottom: 20px;" class="no-print">
                <button class="print-button" onclick="window.print()">Imprimir</button>
            </div>
            <div class="grid" id="shopping-list"></div>
        </div>
    </div>

    <div class="container no-print">
        <h2>‚úÇÔ∏è Mapeamento de Corte</h2>
        <div id="cutting-map"></div>
    </div>

    <script>
        const baseData = {
            tecido: [
                {nome: 'Corpo atr√°s', largura: 15, comprimento: 26, quantidade: 1}, {nome: 'Corpo frente (baixo)', largura: 13, comprimento: 26, quantidade: 1},
                {nome: 'Corpo frente (cima)', largura: 9, comprimento: 26, quantidade: 1}, {nome: 'Fundo', largura: 14, comprimento: 42, quantidade: 1},
                {nome: 'Faixa de z√≠per', largura: 7, comprimento: 42, quantidade: 2}, {nome: 'Faixa para vivo', largura: 3, comprimento: 82, quantidade: 2},
                {nome: 'Al√ßa de m√£o', largura: 5, comprimento: 25, quantidade: 1}, {nome: 'Freios z√≠per bolsos', largura: 3, comprimento: 4, quantidade: 8},
                {nome: 'Freios z√≠per fole', largura: 5, comprimento: 4, quantidade: 1}
            ],
            forro: [
                {nome: 'Corpo atr√°s', largura: 15, comprimento: 26, quantidade: 3}, {nome: 'Corpo frente (baixo)', largura: 13, comprimento: 26, quantidade: 1},
                {nome: 'Corpo frente (cima)', largura: 9, comprimento: 26, quantidade: 1}, {nome: 'Faixa de z√≠per', largura: 7, comprimento: 42, quantidade: 2},
                {nome: 'Fundo', largura: 14, comprimento: 42, quantidade: 1}
            ],
            tela: [
                {nome: 'Bolso interno 1', largura: 12, comprimento: 26, quantidade: 1}, {nome: 'Bolso interno 2', largura: 3, comprimento: 26, quantidade: 1},
                {nome: 'Bolso interno 3', largura: 12, comprimento: 26, quantidade: 1}
            ],
            eva: [
                {nome: 'Estrutura principal', largura: 11, comprimento: 22, quantidade: 1}, {nome: 'Estrutura fundo', largura: 10, comprimento: 38, quantidade: 1},
                {nome: 'Estrutura lateral', largura: 3, comprimento: 38, quantidade: 2}
            ]
        };
        const outros = { fecho: 1.0, cursor: 4, vies: 2.05, cadaco_alca: 0.23, puxador: 4, cadaco_freio: 0.04 };

        function calculateMaterials() {
            const quantity = parseInt(document.getElementById('quantity').value) || 1;
            const results = {
                tecido: calculateMaterialNeeds('tecido', quantity, 140), forro: calculateMaterialNeeds('forro', quantity, 140),
                tela: calculateMaterialNeeds('tela', quantity, 140), eva: calculateMaterialNeeds('eva', quantity, 130)
            };
            displaySummary(results);
            displayShoppingList(results, quantity);
            displayCuttingMap(results);
        }

        function calculateMaterialNeeds(type, quantity, materialWidth) {
            const items = baseData[type];
            let allPieces = [];
            items.forEach(item => {
                for (let i = 0; i < item.quantidade * quantity; i++) {
                    allPieces.push({ ...item, id: `${type}-${item.nome}-${i}` });
                }
            });

            // --- ORDENA√á√ÉO INTELIGENTE ---
            const edgePieces = allPieces.filter(p => p.comprimento / p.largura >= 10 || p.largura / p.comprimento >= 10);
            const mainPieces = allPieces.filter(p => !edgePieces.includes(p));
            mainPieces.sort((a, b) => (b.largura * b.comprimento) - (a.largura * a.comprimento));
            const sortedPieces = [...edgePieces, ...mainPieces];
            // --- FIM DA ORDENA√á√ÉO ---

            const layout = optimizeLayout(sortedPieces, materialWidth);
            const totalLength = layout.totalHeight;
            const finalLength = Math.ceil(totalLength * 1.08);
            return { pieces: sortedPieces, totalLength, finalLength, finalMeters: (finalLength / 100).toFixed(2), layout, materialWidth };
        }

        function optimizeLayout(pieces, binWidth) {
            let bins = [{ width: binWidth, height: Infinity, freeRects: [{ x: 0, y: 0, width: binWidth, height: Infinity }] }];
            let placedPieces = [];
            let totalHeight = 0;

            for (const piece of pieces) {
                let bestFit = { score: Infinity };
                const orientations = piece.largura === piece.comprimento ? [{ w: piece.largura, h: piece.comprimento, rotacionada: false }] :
                                     [{ w: piece.largura, h: piece.comprimento, rotacionada: false }, { w: piece.comprimento, h: piece.largura, rotacionada: true }];

                for (const p of orientations) {
                    for (let i = 0; i < bins[0].freeRects.length; i++) {
                        const rect = bins[0].freeRects[i];
                        if (p.w <= rect.width && p.h <= rect.height) {
                            const score = rect.y + p.h;
                            if (score < bestFit.score) {
                                bestFit = { rectIndex: i, piece: { ...piece, ...p }, score: score, x: rect.x, y: rect.y };
                            }
                        }
                    }
                }

                if (bestFit.rectIndex !== undefined) {
                    const { rectIndex, piece, x, y } = bestFit;
                    placedPieces.push({ ...piece, x, y });
                    totalHeight = Math.max(totalHeight, y + piece.h);
                    
                    const oldRect = bins[0].freeRects.splice(rectIndex, 1)[0];
                    const splitHorizontally = (target, p) => {
                        const newRects = [];
                        if (p.y > target.y) newRects.push({x: target.x, y: target.y, width: target.width, height: p.y - target.y});
                        if (p.y + p.h < target.y + target.height) newRects.push({x: target.x, y: p.y + p.h, width: target.width, height: (target.y + target.height) - (p.y + p.h)});
                        if (p.x > target.x) newRects.push({x: target.x, y: p.y, width: p.x - target.x, height: p.h});
                        if (p.x + p.w < target.x + target.width) newRects.push({x: p.x + p.w, y: p.y, width: (target.x + target.width) - (p.x + p.w), height: p.h});
                        return newRects;
                    };

                    for (let i = bins[0].freeRects.length - 1; i >= 0; i--) {
                        const rect = bins[0].freeRects[i];
                        const intersection = !(rect.x >= x + piece.w || rect.x + rect.width <= x || rect.y >= y + piece.h || rect.y + rect.height <= y);
                        if (intersection) {
                            bins[0].freeRects.splice(i, 1);
                            bins[0].freeRects.push(...splitHorizontally(rect, {x, y, w: piece.w, h: piece.h}));
                        }
                    }
                    
                    bins[0].freeRects = bins[0].freeRects.filter((r1, i1) => !bins[0].freeRects.some((r2, i2) => i1 !== i2 && r2.x <= r1.x && r2.y <= r1.y && r2.x + r2.width >= r1.x + r1.width && r2.y + r2.height >= r1.y + r1.height));
                    bins[0].freeRects.sort((a, b) => a.y - b.y || a.x - b.x);
                }
            }
            const totalPieceArea = placedPieces.reduce((acc, p) => acc + (p.w * p.h), 0);
            const efficiency = binWidth * totalHeight > 0 ? (totalPieceArea / (binWidth * totalHeight) * 100).toFixed(1) : 0;
            return { placedPieces, totalHeight, efficiency };
        }

        function displaySummary(results) {
            const grid = document.getElementById('summary-grid');
            grid.innerHTML = '';
            const materials = [
                { name: 'Tecido Principal', data: results.tecido }, { name: 'Forro', data: results.forro },
                { name: 'Tela Voley', data: results.tela }, { name: 'EVA', data: results.eva }
            ];
            materials.forEach(m => {
                const card = document.createElement('div');
                card.className = 'summary-card';
                card.innerHTML = `
                    <h4>${m.name}</h4>
                    <p>Metragem Otimizada: <strong>${(m.data.totalLength/100).toFixed(2)}m</strong></p>
                    <p>Comprar (c/ margem 8%): <strong class="highlight">${m.data.finalMeters}m</strong></p>
                    <p>Aproveitamento do Corte: <strong>${m.data.layout.efficiency}%</strong></p>`;
                grid.appendChild(card);
            });
        }

        function displayShoppingList(results, quantity) {
            document.getElementById('shopping-list').innerHTML = `
                <div class="card">
                    <h3>üßµ Tecidos e Estrutura</h3>
                    <ul style="list-style: none; padding: 0;">
                        <li>Tecido Principal: <strong class="highlight">${results.tecido.finalMeters}m</strong></li>
                        <li>Forro: <strong class="highlight">${results.forro.finalMeters}m</strong></li>
                        <li>Tela Voley: <strong class="highlight">${results.tela.finalMeters}m</strong></li>
                        <li>EVA (130cm): <strong class="highlight">${results.eva.finalMeters}m</strong></li>
                    </ul>
                </div>
                <div class="card">
                    <h3>‚ú® Aviamentos</h3>
                    <ul style="list-style: none; padding: 0;">
                        <li>Fecho n¬∫5: <strong class="highlight">${(outros.fecho * quantity).toFixed(2)}m</strong></li>
                        <li>Cursores: <strong class="highlight">${outros.cursor * quantity} p√ßs</strong></li>
                        <li>Vi√©s: <strong class="highlight">${(outros.vies * quantity).toFixed(2)}m</strong></li>
                        <li>Cadar√ßo p/ al√ßa: <strong class="highlight">${(outros.cadaco_alca * quantity).toFixed(2)}m</strong></li>
                        <li>Puxadores: <strong class="highlight">${outros.puxador * quantity} p√ßs</strong></li>
                        <li>Cadar√ßo p/ freios: <strong class="highlight">${(outros.cadaco_freio * quantity).toFixed(2)}m</strong></li>
                    </ul>
                </div>`;
        }

        function displayCuttingMap(results) {
            const cuttingMapDiv = document.getElementById('cutting-map');
            cuttingMapDiv.innerHTML = '';
            const materials = [
                { name: 'Tecido Principal', data: results.tecido }, { name: 'Forro', data: results.forro },
                { name: 'Tela Voley', data: results.tela }, { name: 'EVA', data: results.eva }
            ];
            const colors = ['#a8d8b4', '#f5d79e', '#a1c9f4', '#f4a1b9', '#c3a1f4', '#f4b9a1', '#f7c8a0', '#a0d9f7'];

            materials.forEach(material => {
                if (material.data.layout.totalHeight === 0) return;

                const pieceGroups = {};
                material.data.pieces.forEach(piece => {
                    if (!pieceGroups[piece.nome]) {
                        pieceGroups[piece.nome] = { color: colors[Object.keys(pieceGroups).length % colors.length], count: 0, w: piece.largura, h: piece.comprimento };
                    }
                });
                material.data.layout.placedPieces.forEach(p => pieceGroups[p.nome].count++);

                const descriptiveSection = document.createElement('div');
                descriptiveSection.className = 'cutting-section';
                descriptiveSection.innerHTML = `<h3>${material.name} - Lista de Corte</h3>`;
                Object.entries(pieceGroups).forEach(([name, { count, w, h }]) => {
                    if(count > 0) descriptiveSection.innerHTML += `<div class="cutting-item-descriptive"><strong>${count}x</strong> - ${name} (medida: ${w}cm x ${h}cm)</div>`;
                });
                cuttingMapDiv.appendChild(descriptiveSection);

                const visualSection = document.createElement('div');
                visualSection.className = 'cutting-section';
                visualSection.innerHTML = `<h3>${material.name} - Mapa Visual de Alta Precis√£o</h3>`;
                
                const wrapper = document.createElement('div'); wrapper.className = 'cutting-layout-wrapper';
                const viewport = document.createElement('div'); viewport.className = 'cutting-layout-viewport';
                const canvasWrapper = document.createElement('div'); canvasWrapper.className = 'cutting-layout-canvas-wrapper';
                const canvas = document.createElement('div'); canvas.className = 'cutting-layout-canvas';
                
                const scale = 5;
                const canvasWidth = material.data.materialWidth * scale;
                const canvasHeight = material.data.layout.totalHeight * scale;
                canvas.style.width = `${canvasWidth}px`; canvas.style.height = `${canvasHeight}px`;
                canvas.style.backgroundSize = `${10 * scale}px ${10 * scale}px`;

                const hRuler = document.createElement('div'); hRuler.className = 'ruler horizontal';
                const vRuler = document.createElement('div'); vRuler.className = 'ruler vertical';
                const hGuide = document.createElement('div'); hGuide.className = 'guide-line horizontal'; hGuide.style.display = 'none';
                const vGuide = document.createElement('div'); vGuide.className = 'guide-line vertical'; vGuide.style.display = 'none';
                const infoBox = document.createElement('div'); infoBox.className = 'info-box'; infoBox.style.display = 'none';

                for(let i = 0; i <= material.data.materialWidth; i+=2) {
                    const isMajor = i % 10 === 0;
                    const tick = document.createElement('div'); tick.className = `tick ${isMajor ? 'major' : 'minor'}`;
                    tick.style.left = `${i * scale}px`; if(isMajor) tick.textContent = i;
                    hRuler.appendChild(tick);
                }
                for(let i = 0; i <= Math.ceil(material.data.layout.totalHeight); i+=2) {
                    const isMajor = i % 10 === 0;
                    const tick = document.createElement('div'); tick.className = `tick ${isMajor ? 'major' : 'minor'}`;
                    tick.style.top = `${i * scale}px`; if(isMajor) tick.textContent = i;
                    vRuler.appendChild(tick);
                }

                material.data.layout.placedPieces.forEach(piece => {
                    const pieceDiv = document.createElement('div');
                    pieceDiv.className = 'cutting-piece';
                    pieceDiv.dataset.pieceName = piece.nome;
                    pieceDiv.dataset.id = piece.id;
                    pieceDiv.style.width = `${piece.w * scale}px`; pieceDiv.style.height = `${piece.h * scale}px`;
                    pieceDiv.style.left = `${piece.x * scale}px`; pieceDiv.style.top = `${piece.y * scale}px`;
                    pieceDiv.style.backgroundColor = pieceGroups[piece.nome].color;
                    if (piece.w * scale > 100 && piece.h * scale > 25) pieceDiv.textContent = piece.nome;
                    canvas.appendChild(pieceDiv);
                });

                const legendList = document.createElement('ul'); legendList.className = 'legend';
                Object.entries(pieceGroups).forEach(([name, { color, count }]) => {
                    if(count > 0) {
                        const li = document.createElement('li'); li.className = 'legend-item'; li.dataset.pieceName = name;
                        li.innerHTML = `<div class="legend-color-box" style="background-color: ${color};"></div> <span><strong>${count}x</strong> - ${name}</span>`;
                        legendList.appendChild(li);
                    }
                });

                canvasWrapper.append(hRuler, vRuler, canvas, hGuide, vGuide, infoBox);
                viewport.appendChild(canvasWrapper);
                wrapper.appendChild(viewport);
                wrapper.appendChild(legendList);
                visualSection.appendChild(wrapper);
                cuttingMapDiv.appendChild(visualSection);

                const allPieces = wrapper.querySelectorAll('.cutting-piece');
                const allLegendItems = wrapper.querySelectorAll('.legend-item');
                const highlight = (name, state) => {
                    allPieces.forEach(p => { if (p.dataset.pieceName === name) p.classList.toggle('highlight', state); });
                    allLegendItems.forEach(l => { if (l.dataset.pieceName === name) l.classList.toggle('highlight', state); });
                };
                allLegendItems.forEach(item => {
                    item.addEventListener('mouseenter', () => highlight(item.dataset.pieceName, true));
                    item.addEventListener('mouseleave', () => highlight(item.dataset.pieceName, false));
                });
                canvas.addEventListener('mousemove', e => {
                    const rect = canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left + viewport.scrollLeft;
                    const y = e.clientY - rect.top + viewport.scrollTop;
                    hGuide.style.top = `${y}px`; vGuide.style.left = `${x}px`;
                    infoBox.textContent = `X: ${(x/scale).toFixed(1)}cm, Y: ${(y/scale).toFixed(1)}cm`;
                });
                canvas.addEventListener('mouseenter', () => { hGuide.style.display = 'block'; vGuide.style.display = 'block'; infoBox.style.display = 'block'; });
                canvas.addEventListener('mouseleave', () => { hGuide.style.display = 'none'; vGuide.style.display = 'none'; infoBox.style.display = 'none'; highlight(null, false); });
                allPieces.forEach(p => {
                    p.addEventListener('mouseenter', e => {
                        highlight(p.dataset
